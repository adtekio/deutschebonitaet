%script{:src => "/javascript/enc/jose.js"}
%script{:src => "/javascript/enc/yahoo-min.js"}
%script{:src => "/javascript/enc/jsbn.js"}
%script{:src => "/javascript/enc/jsbn2.js"}
%script{:src => "/javascript/enc/prng4.js"}
%script{:src => "/javascript/enc/rng.js"}
%script{:src => "/javascript/enc/base64.js"}
%script{:src => "/javascript/enc/rsa.js"}
%script{:src => "/javascript/enc/rsa2.js"}
%script{:src => "/javascript/enc/ec.js"}
%script{:src => "/javascript/enc/ec-patch.js"}
%script{:src => "/javascript/enc/webcrypto-shim.js"}
%script{:src => "/javascript/enc/asn1hex-1.1.min.js"}
%script{:src => "/javascript/enc/base64x-1.1.min.js"}
%script{:src => "/javascript/enc/ecdsa-modified-1.0.min.js"}
%script{:src => "/javascript/enc/keyutil-1.0.min.js"}
/[if lt IE 9]
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
:javascript
  function encrypt(tan) {
    var keyObj = KEYUTIL.getKey("#{FigoPublicKey}");
    var jwk = KEYUTIL.getJWKFromKey(keyObj);

    var cryptographer = new Jose.WebCryptographer();
    var rsa_key = Jose.Utils.importRsaPublicKey(jwk, "RSA-OAEP");
    cryptographer.setContentEncryptionAlgorithm("A256CBC-HS512");
    var encrypter = new JoseJWE.Encrypter(cryptographer, rsa_key);
    var creds = "";
    if (tan == false) {
      creds = JSON.stringify([$('#user').val(),$('#additional_pin').val(),$('#pin').val()]);
      encrypter.encrypt(creds).then(function(result) {
        document.getElementById("enc_token_field").value = result;
        document.getElementById("send_data").submit();
      }).catch(function(err){
        console.error(err);
      });
    }
    else {
      creds = JSON.stringify($('#tan').val());
      encrypter.encrypt(creds).then(function(result) {
        document.getElementById("creds_type").value = "tan";
        document.getElementById("enc_token_field").value = result;
        document.getElementById("send_data").submit();
      }).catch(function(err){
        console.error(err);
      });
    }
  }

.panel.panel-primary
  .panel-heading
    %h3.panel-title Prepare bank credentials
  .panel-body
    .row
      .col-md-6
        %form#send_data{ :method => :post, :action => "/add_account" }
          %input#creds_type{ :type => :hidden, :name => "creds_type", :value => "account" }
          %input#enc_token_field{:type=>:hidden, :name => "creds", :value => "none"}

        %form{ :onsubmit => "encrypt(false); return false;" }
          .row
            %p
            .col-md-4 IBAN:
            .col-md-6
              %input#iban{:size => "40", :type => "text" }/
            .col-md-2
              %span#ibangood.td-n.mr-5px.brad-100p.bgc-green.d-fx.fxai-c.fxjc-c.c-white.w-25px.h-25px.bs-1{"data-icon" => "checkmark5"}
              %span#ibanbad.td-n.mr-5px.brad-100p.bgc-red.d-fx.fxai-c.fxjc-c.c-white.w-25px.h-25px.bs-1{"data-icon" => "cross4"}
              %img#ibanwait.td-n.mr-5px.brad-100p.bgc-orange.d-fx.fxai-c.fxjc-c.c-white.w-25px.h-25px.bs-1{:src => "/images/loader.svg"}
          .row
            %p
            .col-md-4 Bank:
            .col-md-6
              %span#bankname
          .row
            %p
            .col-md-4 Name:
            .col-md-6
              %input#user{:size => "40", :type => "text" }/
          .row
            %p
            .col-md-4 Password:
            .col-md-6
              %input#pin{:size => "40", :type => "text"}/
          .row
            %p
            .col-md-4 Additional Password:
            .col-md-6
              %input#additional_pin{:size => "40", :type => "text"}/
          %p
          .row
            %p
            .col-md-4
            .col-md-6
              %input.btn.btn-warning{:type => "submit", :value => "Submit"}

:javascript
  $(document).ready(function(){
    $('#ibangood').hide();
    $('#ibanbad').hide();
    $('#ibanwait').hide();

    $('#iban').on('change', function(){
      $('#ibangood').hide();
      $('#ibanbad').hide();
      $('#ibanwait').show();

      $.ajax({
        url: '/iban/check',
        method: 'post',
        dataType: 'json',
        data: { iban: $('#iban').val() }
      }).done(function(data){
        if ( data["r"] ) {
           $('#ibangood').show();
           $('#bankname').html("<img src='/images/loader.svg'>");
           $.ajax({
           url: '/iban/bankname',
           method: 'post',
           dataType: 'json',
           data: { iban: $('#iban').val() }
           }).done(function(data){
             $('#bankname').html(data["r"]);
           });
        } else {
           $('#ibanbad').show();
        }
        $('#ibanwait').hide();
      });
    });
  });
